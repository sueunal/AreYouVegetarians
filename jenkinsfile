pipeline {
    agent any

    environment {
        PROJECT_NAME = "AreYouVegetarians"
        SCHEME_NAME  = "AreYouVegetarians"
        SIMULATOR = "platform=iOS Simulator,name=iPhone 15 Pro,OS=18.3.1"

    }


    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo 'Git ì €ì¥ì†Œì—ì„œ í”„ë¡œì íŠ¸ ì½”ë“œ ê°€ì ¸ì˜¤ê¸°'
                checkout scm
            }
        }

        stage('ğŸ› ï¸ Build') {
            steps {
                echo 'Xcode í”„ë¡œì íŠ¸ ë¹Œë“œ ì‹œì‘'
                sh """
                    cd ${PROJECT_NAME}
                    xcodebuild clean -project ${PROJECT_NAME}.xcodeproj -scheme ${SCHEME_NAME} -configuration Debug
                """
            }

        }
	stage('Unit Test') {
            steps {
                sh '''
                xcodebuild \
                    -workspace $WORKSPACE \
                    -scheme $SCHEME \
                    -destination "$DESTINATION" \
                    -sdk iphonesimulator \
                    -enableCodeCoverage YES \
                    clean test | tee xcodebuild.log | xcpretty -r junit -o build/reports/junit.xml
                '''
            }
            post {
                always {
                    junit 'build/reports/junit.xml' // í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ Jenkinsì— ë¦¬í¬íŠ¸
                }
            }
        }

	stage('UI Test') {
            steps {
                sh '''
                xcodebuild \
                    -workspace $WORKSPACE \
                    -scheme $SCHEME \
                    -destination "$DESTINATION" \
                    -sdk iphonesimulator \
                    -only-testing:MyAppUITests \
                    clean test | tee xcodebuild_ui.log | xcpretty -r junit -o build/reports/ui_junit.xml
                '''
            }
            post {
                always {
                    junit 'build/reports/ui_junit.xml'
                }
            }
        }

        stage('ğŸ§ª Test') {
            steps {
                echo 'Xcode í…ŒìŠ¤íŠ¸ ì‹¤í–‰'
                sh """
                    cd ${PROJECT_NAME}
                    xcodebuild test -project ${PROJECT_NAME}.xcodeproj -scheme ${SCHEME_NAME} -destination '${SIMULATOR}'
                """
            }
        }

        stage('âœ… Done') {
            steps {
                echo 'âœ… CI/CD ì™„ë£Œ!'
            }
        }
    }

    post {
        failure {
            echo 'ğŸš¨ ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
        }
    }
}

